layout: post
title: 网站安全访问
categories: project
tags:
  - project
---

### 背景

2015年6月，维基媒体基金会发布公告，旗下所有网站将默认开启HTTPS，这些网站中最为人所知的当然是全球最大的在线百科-维基百科。而更早时候的3月，百度已经发布公告，百度全站默认开启HTTPS。淘宝也默默做了全站HTTPS。

网站实现HTTPS，在国外已经非常普及，也是必然的趋势。Google、Facebook、Twitter等巨头公司早已经实现全站HTTPS，而且为鼓励全球网站的HTTPS实现，Google甚至调整了搜索引擎算法，让采用HTTPS的网站在搜索中排名更靠前。但是在国内，HTTPS网站进展并不好，大部分的电商网站也仅仅是对账户登录和交易做HTTPS，比如京东；很多网站甚至连登录页面也没有实现HTTPS…这里面有很多的原因，比如现有架构改动的代价过大、CDN实现困难、对用户隐私和安全的不重视等

还有个重要原因是担心网站实现HTTPS后，网站的用户体验和性能下降明显。事实上，通过合理部署和优化，HTTPS网站的访问速度和性能基本不会受到影响。

比如你在百度搜索了一个关键词“https“，中间者通过tcpdump或者wireshark等工具就很容易知道发送请求的全部内容。

<!--more-->

### 什么是HTTPS网站
	
HTTPS可以理解为HTTP+TLS，HTTP是互联网中使用最为广泛的协议，目前大部分的WEB应用和网站都是使用HTTP协议传输。主流版本是HTTP1.1，HTTP2.0还未正式普及，2.0由Google的SPDY协议演化而来，在性能上有明显的提升。

httpc| https
---- | -----
http | http
     | ssl or tls
tcp  | tcp
ip   | ip

TLS是传输层加密协议，是HTTPS安全的核心，其前身是SSL，主流版本有SSL3.0、TLS1.0、TLS1.1、TLS1.2。SSL3.0和TLS1.0由于存在安全漏洞，已经很少被使用到。

### 保护用户隐私和网络安全

* 数据保密性。保证内容在传输过程中不会被第三方查看到。就像快递员传递包裹时都进行了封装，别人无法知道里面装了什么东西。

* 数据完整性。及时发现被第三方篡改的传输内容。就像快递员虽然不知道包裹里装了什么东西，但他有可能中途掉包，数据完整性就是指如果被掉包，我们能轻松发现并拒收。

* 身份校验。保证数据到达用户期望的目的地。就像我们邮寄包裹时，虽然是一个封装好的未掉包的包裹，但必须确定这个包裹不会送错地方。

一言概之，为保护用户隐私和网络安全。通过数据加密、校验数据完整性和身份认证三种机制来保障安全。

#### 数据加密

* 非对称加密及密钥交换

* 对称加密（加密和解密都使用的是同一个密钥）

HTTPS一般使用的加密与HASH算法如下：

* 非对称加密算法：RSA，DSA/DSS
* 对称加密算法：AES，RC4，3DES
* HASH算法：MD5，SHA1，SHA256

#### 数据完整性

这部分内容相对比较简单，openssl现在使用的完整性校验算法有两种：MD5或者SHA。由于MD5在实际应用中存在冲突的可能性比较大，所以尽量别采用MD5来验证内容一致性。SHA也不能使用SHA0和SHA１，中国山东大学的王小云教授在2005年就牛逼地宣布破解了SHA-1完整版算法。建议使用SHA２算法，即输出的摘要长度超过224位。

#### 身份验证和授权

这里主要介绍的就是PKI和数字证书。数字证书有两个作用：

* 身份验证：确保客户端访问的网站是经过CA验证的可信任的网站。

* 分发公钥：每个数字证书都包含了注册者生成的公钥，在SSL握手时会通过certificate消息传输给客户端。


### 提高HTTPS网站性能和访问速度

如果你认为网站加上TLS证书，就是HTTPS网站了，那你就跟12306犯了同样的错误……
首先，网站在加上TLS证书时，为什么会变慢？这主要又两方面造成：

* HTTPS比HTTP在通信时会产生更多的通信过程，随之RTT时间就会增加；

* HTTPS通信过程的非对称和对称加解密计算会产生更多的服务器性能和时间上的消耗。

### HTTPS网站的直观了解

推荐一个在线版全球知名的HTTPS网站检测工具-SSL Labs。Qualys SSL Labs同时也是很具有影响力的SSL安全和性能研究机构。在线检测地址为：<https://www.ssllabs.com/ssltest>

### https网站优化

每个HTTPS网站其实都有着巨大的优化空间。下面我们结合WildDog网站，来看看QPS值从30000到80000，加载时延从800ms到300ms，这中间的每个优化点是怎样的。

* HSTS

* Session Resume

* OCSP Stapling

* SPDY和HTTP2.0

* TCP优化

* TLS Record Size

* 证书链完整且不冗余

* 移动设备上的ChaCha20-Poly1305

### 补充资料

* DNS劫持

	DNS劫持就是通过劫持了DNS服务器，通过某些手段取得某域名的解析记录控制权，进而修改此域名的解析结果，导致对该域名的访问由原IP地址转入到修改后的指定IP，其结果就是对特定的网址不能访问或访问的是假网址，从而实现窃取资料或者破坏原有正常服务的目的。DNS劫持通过篡改DNS服务器上的数据返回给用户一个错误的查询结果来实现的。
	DNS劫持症状：在某些地区的用户在成功连接宽带后，首次打开任何页面都指向ISP提供的“电信互联星空”、“网通黄页广告”等内容页面。还有就是曾经出现过用户访问Google域名的时候出现了百度的网站。这些都属于DNS劫持。
	再说简单点，当你输入google.com这个网址的时候，你看到的网站却是百度的首页。

* HTTP劫持

	HTTP劫持是在使用者与其目的网络服务所建立的专用数据通道中，监视特定数据信息，提示当满足设定的条件时，就会在正常的数据流中插入精心设计的网络数据报文，目的是让用户端程序解释“错误”的数据，并以弹出新窗口的形式在使用者界面展示宣传性广告或者直接显示某网站的内容。



	